<%
=begin%>
 <div class="search">

  <div class="column-block">

    <h1>Configured instances
      <div id="install-in-progress" class="btn btn-xs text-success" style="display: none;"><i class="fa fa-refresh"></i>&nbsp;Operation in progress</div>
      <%= link_to('<i class="fa fa-refresh"></i>&nbsp;Operation complete, reload page'.html_safe, url_for, :id => "reload-page", :class => 'btn btn-xs text-success', :style => "display: none;") %>
      <% if kpm_plugin_installed?(@nodes_info) %>
        <div class="pull-right">
          <%= link_to 'Install new plugin', plugins_path %>
        </div>
      <% end %>
    </h1>

    <div id="nodes-table-wrapper">
      <%= render :partial => 'kpm/nodes_info/nodes_table', :locals => {:nodes_info => @nodes_info} %>
    </div>

  </div>

  <div class="column-block">

    <h1>Logs</h1>

    <div id="logs-table-wrapper">
      <%= render :partial => 'kpm/nodes_info/logs_table', :locals => {:kb_host => @kb_host} %>
    </div>

  </div>
</div>

<%= javascript_tag do %>
  $(document).ready(function() {
    refreshLogs('<%= nodes_info_refresh_path(:kb_host => @kb_host, :last_event_id => @last_event_id, :format => :js) %>');

    $('.plugin-link').one('ajax:beforeSend', function() {
      // Prevent other clicks
      $('.plugin-link').removeAttr('data-remote')
                       .removeAttr('data-method')
                       .removeAttr('href')

      // Spin
      $(this).children().addClass('fa-spin');
    });
    $('.plugin-link').one('ajax:complete', function() {
      // Delay a bit, to give time for the plugin state to change before the next refresh
      setTimeout(fakeOperationComplete, 6000);
    });

    <%- if @installing %>
      // Prevent other clicks
      $('.plugin-link').removeAttr('data-remote')
                       .removeAttr('data-method')
                       .removeAttr('href')
      $('#nodes-table-wrapper').css({ opacity: 0.5 });

      $('#install-in-progress').show();
      $('#install-in-progress').children().addClass('fa-spin');

      setTimeout(fakeOperationComplete, 6000);
    <% end %>

    function fakeOperationComplete() {
      $('#install-in-progress').hide();

      $('.plugin-link').children().removeClass('fa-spin');
      $('#nodes-table-wrapper').fadeTo("slow", 0.5);
      $('#reload-page').fadeIn("slow");
    }
  });
<% end %> 
<%
=end%>


<div class="kaui-container">
  <%= render partial: 'kaui/components/breadcrumb/breadcrumb', locals: {
    breadcrumbs: [
      { label: 'Settings', href: '/' },
      { label: "Plugin Manager", href: '#' }
    ]
  } %>

  <div class="d-flex" style="gap: 4rem;">
    <%= render template: 'kaui/layouts/kaui_setting_sidebar', 
      locals: {
        identifier: "Settings",
        controller: params[:controller],
        menu_items: [
          { label: 'Account', path: kaui_engine.admin_tenant_path(session[:tenant_id]), controller_suffix: "#{session[:tenant_id]}", icon_path: 'kaui/setting/account.svg' },
          { label: 'Tenants', path: kaui_engine.admin_tenants_path, controller_suffix: 'admin_tenants', icon_path: 'kaui/setting/tenants.svg' },
          { label: 'Users', path: kaui_engine.admin_allowed_users_path, controller_suffix: 'admin_allowed_users', icon_path: 'kaui/setting/users.svg' },
          { label: 'Tags', path: kaui_engine.tags_path, controller_suffix: 'tags', icon_path: 'kaui/setting/tags.svg' },
          { label: 'Tag Definitions', path: kaui_engine.tag_definitions_path, controller_suffix: 'tag_definitions', icon_path: 'kaui/setting/tag-definitions.svg' },
          { label: 'Custom Fields', path: kaui_engine.custom_fields_path, controller_suffix: 'custom_fields', icon_path: 'kaui/setting/custom-field.svg' },
          { label: 'Plugin Manager', path: "/kpm", controller_suffix: 'kpm', icon_path: 'kaui/setting/plugins.svg' },
          { label: 'E-notifications', path: "/kenui", controller_suffix: 'kenui', icon_path: 'kaui/setting/e-notifications.svg' },
          { label: 'Analytics', path: "#", controller_suffix: 'invoices', icon_path: 'kaui/setting/analytics.svg' },
        ]
      }
    %>

    <div class="admin-tenant-details w-100">
      <div class="d-flex flex-column">
        <div class="admin-tenant-details-header">
          <h2>Plugin Manager</h2>
          <span>
            <div id="install-in-progress" class="btn btn-xs text-success" style="display: none;">
              <i class="fa fa-refresh"></i>&nbsp;Operation in progress
            </div>
            <%= link_to url_for, id: "reload-page", style: "display: none;" do %>
              <%= render "kaui/components/button/button", {
                label: '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M9.66667 1.33301L10.3333 3.03177C9.5386 2.60711 8.63073 2.36637 7.66667 2.36637C4.53705 2.36637 2 4.90342 2 8.03303C2 9.2271 2.36933 10.4194 3 11.333" stroke="#A4A7AE" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M5.66667 14.667L5 12.9682C5.79477 13.3928 6.7026 13.6336 7.66667 13.6336C10.7963 13.6336 13.3333 11.0966 13.3333 7.96695C13.3333 6.77282 12.964 5.58055 12.3333 4.66699" stroke="#A4A7AE" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg> Operation Complete, Reload Page'.html_safe,
                variant: "outline-secondary d-inline-flex align-items-center gap-1",
                type: "button",
                html_class: "kaui-button custom-hover mx-2"
              } %>
            <% end %>

              
            <% if kpm_plugin_installed?(@nodes_info) %>
              <div class="pull-right">
                <%= link_to plugins_path do %>
                  <%= render "kaui/components/button/button", {
                    label: 'Install new plugin',
                    variant: "outline-secondary d-inline-flex align-items-center gap-1",
                    type: "button",
                    html_class: "kaui-dropdown custom-hover",
                  } %>
                <% end %>
              </div>
            <% end %>
          </span>
        </div>

        <!-- Button Tabs -->
        <div class="plugin-tabs my-4">
          <button type="button" class="plugin-tab activelink" data-target=".official-plugins-table">Official Plugins</button>
          <button type="button" class="plugin-tab" data-target=".nodes-table-wrapper">Configured Instances</button>
          <button type="button" class="plugin-tab" data-target=".logs-table-wrapper">Logs</button>
        </div>

        <!-- Plugin Sections -->
        <div id="official-plugins-table">
          <div class="official-plugins-table" style="display: block;">
            <%= render partial: 'kpm/nodes_info/official_plugins', locals: { nodes_info: @nodes_info } %>
          </div>
        </div>

        <div id="nodes-table-wrapper" style="">
          <div class="nodes-table-wrapper" style="display: none;">
            <%= render partial: 'kpm/nodes_info/nodes_table', locals: { nodes_info: @nodes_info } %>
          </div>
        </div>

        <div id="logs-table-wrapper">
          <div class="logs-table-wrapper" style="display: none;">
            <%= render partial: 'kpm/nodes_info/logs_table', locals: { kb_host: @kb_host } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<style>
  .admin-tenant-details-header {
    display: flex;
    align-items: start;
    justify-content: space-between;
    padding: 0;
    border-bottom: 0.0625rem solid #E9EAEB;
  }

  .admin-tenant-details-header h2 {
    font-weight: 600;
    font-size: 1.125rem;
    color: #414651;
    margin-bottom: 1.25rem;
  }

  .plugin-tabs {
    background-color: #FAFAFA;
    border: 0.0625rem solid #E9EAEB;
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-bottom: 1.5rem;
    padding: 0.25rem;
    width: fit-content;
    height: 2.5rem;
  }

  .plugin-tabs button {
    background: transparent;
    border: none;
    font-weight: 500;
    font-size: 0.875rem;
    color: #717680;
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    cursor: pointer;
    height: 2rem;
    display: flex;
    align-items: center;
  }

  .plugin-tabs .activelink {
    color: #414651;
    background-color: #FFFFFF;
    box-shadow: 0 0.0625rem 0.188rem rgba(10, 13, 18, 0.1);
  }

  table {
    overflow-x: auto;
    min-width: 100%;
  }

  table th {
    padding: 0.375rem 0.75rem !important;
    font-weight: 500;
    font-size: 0.875rem;
    color: #717680;
    text-transform: capitalize;
  }

  table td {
    font-weight: 500 !important;
    font-size: 0.875rem !important;
    padding: 1rem 0.5rem !important;
    color: #535862 !important;
    text-transform: capitalize !important;
  }

  table thead tr th::after,
  table thead tr th::before {
    content: "" !important;
    display: inline-block !important;
    width: 0.75rem !important;
    height: 0.75rem !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
    background-size: 0.75rem 0.75rem !important;
    position: absolute !important;
    right: 0.5rem !important;
  }

  table thead tr th::after {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M3 5.5L6 2.5L9 5.5' stroke='%23A4A7AE' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    top: 45% !important;
    transform: translateY(-50%) !important;
  }

  table thead tr th::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M3 6.5L6 9.5L9 6.5' stroke='%23A4A7AE' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    bottom: 45% !important;
    transform: translateY(50%) !important;
  }
</style>

<!-- JavaScript -->
<%= javascript_tag do %>
  $(document).ready(function () {
    refreshLogs('<%= nodes_info_refresh_path(kb_host: @kb_host, last_event_id: @last_event_id, format: :js) %>');

    $('.plugin-tab').on('click', function () {
      $('.plugin-tab').removeClass('activelink');
      $(this).addClass('activelink');

      const target = $(this).data('target');

      // Hide all
      $('.official-plugins-table, .nodes-table-wrapper, .logs-table-wrapper').css('display', 'none');
      // Show selected
      $(target).css('display', 'block');
    });

    $('.plugin-link').one('ajax:beforeSend', function () {
      $('.plugin-link').removeAttr('data-remote data-method href');
      $(this).children().addClass('fa-spin');
    });

    $('.plugin-link').one('ajax:complete', function () {
      setTimeout(fakeOperationComplete, 6000);
    });

    <% if @installing %>
      $('.plugin-link').removeAttr('data-remote data-method href');
      $('#nodes-table-wrapper').css({ opacity: 0.5 });
      $('#install-in-progress').show();
      $('#install-in-progress').children().addClass('fa-spin');
      setTimeout(fakeOperationComplete, 6000);
    <% end %>

    function fakeOperationComplete() {
      $('#install-in-progress').hide();
      $('.plugin-link').children().removeClass('fa-spin');
      $('#nodes-table-wrapper').fadeTo("slow", 0.5);
      $('#reload-page').fadeIn("slow");
    }
  });
<% end %>
